<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>مولّد QR الجمالي — Rizzo</title>
<style>
  :root{--bg:#0b0b0f;--panel:#121217;--ink:#eaeaea;--muted:#9aa0a6;--acc:#ffd166;}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,"Segoe UI","Tahoma","Arial",sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  h1{margin:0 0 10px;font-weight:900;font-size:clamp(20px,5vw,32px);text-align:center}
  .card{background:var(--panel);border:1px solid #232636;border-radius:16px;padding:14px;box-shadow:0 12px 40px rgba(0,0,0,.4)}
  .grid{display:grid;grid-template-columns:340px 1fr;gap:12px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .side{display:flex;flex-direction:column;gap:10px}
  label{font-size:13px;color:#cbd1db;margin-bottom:4px}
  input[type="text"], select{
    width:100%;background:#0f1118;color:#eaecef;border:1px solid #2a2f3f;border-radius:10px;
    padding:10px 12px;outline:none;font-size:14px
  }
  input[type="range"]{width:100%}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  button{
    background:linear-gradient(180deg,var(--acc),#ffcc33);color:#101214;border:0;border-radius:12px;
    padding:10px 14px;font-weight:800;cursor:pointer;box-shadow:0 8px 24px rgba(255,209,102,.25)
  }
  .muted{color:var(--muted);font-size:12px}
  .canvasWrap{display:flex;flex-direction:column;align-items:center;gap:10px}
  canvas{background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .block{background:#0f1118;border:1px dashed #2a2f3f;border-radius:12px;padding:10px;text-align:center}
  .block input[type="file"]{width:100%}
  .pill{padding:4px 8px;border-radius:999px;border:1px solid #2a2f3f;background:#0f1118;font-size:12px}
  small.tip{display:block;color:#b7bec9}
</style>
</head>
<body>
<div class="wrap">
  <h1>مولّد QR الجمالي — Rizzo</h1>
  <div class="card">
    <div class="grid">
      <div class="side">
        <div>
          <label>اختصار روابطك</label>
          <select id="quick">
            <option value="">— اختر رابطاً سريعاً —</option>
            <option value="https://0xRizzo.github.io/rizzo-links/snap.html">Snap</option>
            <option value="https://0xRizzo.github.io/rizzo-links/insta.html">Insta</option>
            <option value="https://0xRizzo.github.io/rizzo-links/youtube.html">YouTube</option>
            <option value="https://0xRizzo.github.io/rizzo-links/china.html">China (Link)</option>
            <option value="https://0xRizzo.github.io/rizzo-links/slim.html">Slim (Link)</option>
            <option value="https://0xRizzo.github.io/rizzo-links/prank.html">Prank</option>
            <option value="https://0xRizzo.github.io/rizzo-links/final.html">Final (Certificate)</option>
          </select>
        </div>
        <div>
          <label>نص/رابط الكود</label>
          <input id="data" type="text" placeholder="ضع رابط GitHub Pages أو النص (يدعم UTF-8)"
            value="https://0xRizzo.github.io/rizzo-links/final.html"/>
          <small class="tip">للنص الصيني استخدم: 你好，欢迎来到 Rizzo 的世界！</small>
        </div>

        <div>
          <label>حجم الكود (بكسل)</label>
          <input id="size" type="range" min="256" max="1024" step="16" value="512"/>
          <div class="row"><span class="pill" id="sizeLabel">512 px</span></div>
        </div>

        <div class="block">
          <label>شعار وسط الكود (اختياري)</label>
          <input id="logo" type="file" accept="image/*"/>
          <small class="tip">البرنامج يضبط المقاس تلقائياً (~20% من عرض الـQR) ويحط خلفه مربع أبيض صغير للحماية.</small>
        </div>

        <div class="block">
          <label>صورة خلفية (اختياري)</label>
          <input id="bg" type="file" accept="image/*"/>
          <label>شفافية الخلفية</label>
          <input id="bgAlpha" type="range" min="0" max="100" value="15"/>
        </div>

        <div class="block">
          <label>قناع (Mask) — سيلويت PNG (اختياري)</label>
          <input id="mask" type="file" accept="image/png"/>
          <small class="tip">استخدم صورة سيلويت بخلفية شفافة. الكود سيظهر داخل شكل السيلويت فقط.</small>
        </div>

        <div class="row">
          <button id="gen">توليد الكود</button>
          <button id="save">حفظ PNG</button>
        </div>
        <div class="muted">Static QR, يعمل مدى الحياة — بدون أي سيرفر.</div>
      </div>

      <div class="canvasWrap">
        <canvas id="cv" width="512" height="512"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- مكتبة توليد QR محلياً (احفظ qrcode.min.js جنب هذا الملف) -->
<script src="qrcode.min.js"></script>
<script>
  // عناصر
  const dataEl = document.getElementById('data');
  const sizeEl = document.getElementById('size');
  const sizeLabel = document.getElementById('sizeLabel');
  const logoEl = document.getElementById('logo');
  const bgEl = document.getElementById('bg');
  const maskEl = document.getElementById('mask');
  const bgAlphaEl = document.getElementById('bgAlpha');
  const quickEl = document.getElementById('quick');
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');

  // تحديث الحجم
  function setSize(px){
    cv.width = px; cv.height = px;
    sizeLabel.textContent = px + ' px';
  }
  setSize(+sizeEl.value);
  sizeEl.addEventListener('input', e=> setSize(+e.target.value));
  quickEl.addEventListener('change', e=>{
    if(e.target.value) dataEl.value = e.target.value;
  });

  // توليد QR على كانفس وسيط بنمط أبيض/أسود
  function makeQRCanvas(text, px){
    // استخدام qrcode.js: نولد في DOM ثم ناخذ Canvas
    const tmp = document.createElement('div');
    const qr = new QRCode(tmp, {
      text, width: px, height: px,
      colorDark: "#000000", colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H // أعلى تصحيح خطأ لدعم الشعار
    });
    // qrcode.js يرسم <img>؛ نحوّلها لCanvas
    const img = tmp.querySelector('img') || tmp.querySelector('canvas');
    return new Promise(res=>{
      if(img.complete) {
        const c = document.createElement('canvas'); c.width = px; c.height = px;
        const cctx = c.getContext('2d'); cctx.drawImage(img, 0, 0, px, px); res(c);
      } else {
        img.onload = ()=>{
          const c = document.createElement('canvas'); c.width = px; c.height = px;
          const cctx = c.getContext('2d'); cctx.drawImage(img, 0, 0, px, px); res(c);
        };
      }
    });
  }

  function readImage(file){
    return new Promise((res,rej)=>{
      if(!file) return res(null);
      const fr = new FileReader();
      fr.onload = ()=>{
        const img = new Image();
        img.onload = ()=> res(img);
        img.onerror = rej;
        img.src = fr.result;
      };
      fr.onerror = rej;
      fr.readAsDataURL(file);
    });
  }

  async function generate(){
    const text = dataEl.value.trim();
    const px = +sizeEl.value;
    if(!text){ alert('اكتب رابط/نص أولاً'); return; }

    // نظّف اللوحة
    ctx.clearRect(0,0,cv.width,cv.height);

    // خلفية (إن وُجدت)
    const bgImg = await readImage(bgEl.files[0]);
    if(bgImg){
      ctx.drawImage(bgImg, 0,0, cv.width, cv.height);
      const alpha = (+bgAlphaEl.value)/100;
      ctx.fillStyle = `rgba(255,255,255,${1-alpha})`;
      ctx.fillRect(0,0,cv.width,cv.height);
    } else {
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0,0,cv.width,cv.height);
    }

    // توليد QR خام
    const qrCanvas = await makeQRCanvas(text, px);

    // لو فيه قناع (سيلويت): نطبّق القناع بحيث نظهر أجزاء الـQR داخل الشكل فقط
    const maskImg = await readImage(maskEl.files[0]);
    if(maskImg){
      // نرسم الـQR على طبقة
      const layer = document.createElement('canvas'); layer.width=px; layer.height=px;
      const lctx = layer.getContext('2d');
      lctx.drawImage(qrCanvas, 0, 0);

      // نستخدم القناع: نرسم السيلويت كـ alpha mask
      lctx.globalCompositeOperation = 'destination-in';
      lctx.drawImage(maskImg, 0, 0, px, px);

      // نطبق الطبقة المقنّعة على اللوحة
      ctx.drawImage(layer, 0, 0);
    } else {
      // بدون قناع: نرسم الـQR مباشرة
      ctx.drawImage(qrCanvas, 0, 0);
    }

    // شعار في الوسط (إن وُجد)
    const logoImg = await readImage(logoEl.files[0]);
    if(logoImg){
      const pad = Math.floor(px * 0.02);         // هامش أبيض بسيط
      const box = Math.floor(px * 0.22);         // حجم الإطار/الشعار
      const cx = Math.floor((px - box)/2);
      const cy = Math.floor((px - box)/2);

      // خلفية بيضاء صغيرة تحت الشعار عشان تساعد المسح
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(cx, cy, box, box);

      // رسم الشعار
      ctx.drawImage(logoImg, cx+pad, cy+pad, box-2*pad, box-2*pad);

      // إطار خفيف
      ctx.strokeStyle = "#e5e7eb";
      ctx.lineWidth = Math.max(1, Math.floor(px*0.004));
      ctx.strokeRect(cx, cy, box, box);
    }
  }

  document.getElementById('gen').addEventListener('click', generate);

  document.getElementById('save').addEventListener('click', ()=>{
    const a = document.createElement('a');
    a.download = 'qr-art.png';
    a.href = cv.toDataURL('image/png');
    a.click();
  });
</script>
</body>
</html>
